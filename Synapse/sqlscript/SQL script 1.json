{
	"name": "SQL script 1",
	"properties": {
		"content": {
			"query": "CREATE SCHEMA hub\nGO\n\n-- hub.Station\nIF OBJECT_ID(N'hub.Station') IS NOT NULL DROP TABLE [hub].[Station]\nCREATE TABLE [hub].[Station]([station_id] NVARCHAR(50), [name] NVARCHAR(75), [latitude] FLOAT, [longitude] FLOAT)\n\nINSERT INTO [hub].[Station]\nSELECT s.station_id, s.name, s.latitude, s.longitude\nFROM [raw].[stations] s\n\n-- hub.Rider\nIF OBJECT_ID(N'hub.Rider') IS NOT NULL DROP TABLE [hub].[Rider]\nCREATE TABLE [hub].[Rider]([rider_id] INT, [address] NVARCHAR(100), [first] NVARCHAR(50), [last] NVARCHAR(50), [birthday] DATE, [account_start_date] DATE, [account_end_date] DATE, [is_member] BIT)\n\nINSERT INTO [hub].[Rider]\nSELECT \n    r.rider_id, r.address, r.first, r.last,\n    CAST(r.birthday AS DATE) AS [birthday],\n    CAST(r.account_start_date AS DATE) AS [account_start_date],\n    CAST(r.account_end_date AS DATE) AS [account_end_date],\n    r.is_member\nFROM [raw].[riders] r\n\n-- hub.Payment \nIF OBJECT_ID(N'hub.Payment') IS NOT NULL DROP TABLE [hub].[Payment]\nCREATE TABLE [hub].[Payment]([payment_id] INT, [payment_date] DATE, [rider_id] INT, [amount] DECIMAL(10,2))\n\nINSERT INTO [hub].[Payment]\nSELECT p.payment_id, \n       CAST(p.date AS DATE) AS [payment_date], \n       p.rider_id,\n       CAST(p.amount AS DECIMAL(10,2)) AS [amount]\nFROM [raw].[payments] p\n\n\n-- hub.Trip\nIF OBJECT_ID(N'hub.Trip') IS NOT NULL DROP TABLE [hub].[Trip]\nCREATE TABLE [hub].[Trip]([trip_id] nvarchar(50), [start_station_id] nvarchar(50), [end_station_id] nvarchar(50), [rider_id] int, [started_at] datetime, [age_of_rider] int, [duration] bigint)\nINSERT INTO [hub].[Trip]\nSELECT \n    t.trip_id, t.start_station_id, t.end_station_id, t.rider_id, \n    CAST(t.start_at AS DATETIME2) AS [started_at],  \n    DATEDIFF(year, CAST(r.birthday AS DATE), CAST(t.start_at AS DATE)) -\n        CASE\n            WHEN (MONTH(CAST(r.birthday AS DATE)) >= MONTH(CAST(t.start_at AS DATE)) AND DAY(CAST(r.birthday AS DATE)) > DAY(CAST(t.start_at AS DATE))) THEN 1\n            ELSE 0\n        END AS [age_of_rider],\n    DATEDIFF(second, t.ended_at, t.start_at) AS [duration]\nFROM [raw].[trips] t\nINNER JOIN [raw].[riders] r\nON t.rider_id = r.rider_id\n\n\n-- hub.Date\nIF OBJECT_ID(N'hub.Date') IS NOT NULL DROP TABLE [hub].[Date]\nIF OBJECT_ID(N'tmp_datetime') IS NOT NULL DROP TABLE tmp_datetime\n\nCREATE TABLE [hub].[Date] ([datetime] DATETIME2, [date] DATE, [day_of_week] INT, [time_of_day] NVARCHAR(50), [month] INT,[quarter] INT, [year] INT)\n\nCREATE TABLE tmp_datetime([datetime] DATETIME2)\n\nINSERT INTO tmp_datetime\nSELECT DISTINCT * FROM\n(\nSELECT DISTINCT CAST(t.start_at AS DATETIME2) AS [datetime]\nFROM [raw].[trips] t\nUNION\nSELECT DISTINCT CAST(t.ended_at AS DATETIME2) AS [datetime]\nFROM [raw].[trips] t\nUNION\nSELECT DISTINCT CAST(p.date AS DATETIME2) AS [datetime]\nFROM [raw].[payments] p\n) AS DT\nGO\n\nINSERT INTO [hub].[Date] \nSELECT \n    [datetime],\n    CAST([datetime] AS DATE) AS [date],\n    DATEPART(WEEKDAY,  [datetime]),\n    CONVERT(VARCHAR(50), \n        CASE WHEN FORMAT([datetime], 'HH:mm') BETWEEN '05:00' AND '11:59' THEN 'Morning'\n             WHEN FORMAT([datetime], 'HH:mm') BETWEEN '12:00' AND '16:59' THEN 'Afternoon'\n             WHEN FORMAT([datetime], 'HH:mm') BETWEEN '19:00' AND '21:59' THEN 'Evening'\n             ELSE 'Night'\n        END\n    ),\n    DATEPART(MONTH, [datetime]),\n    DATEPART(QUARTER, [datetime]),\n    DATEPART(YEAR, [datetime])\nFROM tmp_datetime\n\nDROP TABLE tmp_datetime\n\n",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "test_udacity",
				"poolName": "test_udacity"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}